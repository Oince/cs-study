# ARP (Address Resolution Protocol)

> IP 주소를 MAC 주소와 매칭시키기 위한 프로토콜

컴퓨터와 컴퓨터 간 통신은 IP 주소 기반으로 통신한다고 하지만,
조금 더 자세히 보자면 IP 주소에서 ARP를 통해 MAC 주소를 찾아 MAC 주소를 기반으로 통신한다.

ARP는 IP 주소로부터 MAC 주소를 매칭시키는 프로토콜이다.

그 반대인 MAC 주소로부터 IP 주소를 매칭시키는 프로토콜은 `RARP(Reverse Address Resolution Protocol)`라고 한다.

IP 주소와 MAC 주소를 일대일로 매칭시킨 정보를 정리해 둔 테이블을 ARP 테이블이라고 한다.
이러한 ARP 테이블을 통해 실제 MAC 주소를 얻어오고 하는 것.

ARP 테이블은 동적으로 학습해서 테이블에 주소를 추가할 수 있는데, 

1. ARP Request
    - 브로드 캐스트를 통해 대상 IP 주소에 해당하는 컴퓨터의 MAC 주소를 찾는다
    - 📢: 누가 이 IP를 가지고 있는지 물어보고, 해당 IP를 가지고 있는 컴퓨터가 있으면 해당 컴퓨터의 MAC 주소가 무엇인지 알려줘 (전체 채팅 확성기 시작)
2. ARP Reply
    - ARP Reply 패킷으로 응답
    - 💬: 내가 이 IP를 가지고 있고 내 MAC 주소는 XXX야.

이와 같은 과정을 통해 추가할 수 있다.

# 라우팅 (Routing)

3계층(네트워크 계층)에서 라우터 기능을 가지고 있는 장비(라우터/L3 스위치)가 수행한다.

해당 네트워크 장비에 들어오는 패킷의 목적지 IP 주소를 확인하고, 자신이 가지고 있는 경로 정보(라우팅 테이블)를 이용하여 패킷을 최적의 경로로 포워딩하는 것이다.

라우팅을 하는 네트워크 장비는 라우터이다.
라우터의 동작 방식에 대해 간단히 정리해보았다.

## 라우터의 동작 방식

1. 경로 지정 - 라우팅/스위칭
2. 브로드캐스트 컨트롤
3. 프로토콜 변환

이 세가지로 이루어져 있다.

### 1. 경로 지정

> 경로 지정, 패킷 포워딩
> 
- 경로 지정
    - 경로 정보를 얻어 경로 정보를 정리 (라우팅 테이블 생성)
- 패킷 포워딩
    - 정리된 경로 정보를 기반으로 패킷을 포워딩
    - 자신이 알고 있는 주소(라우팅 테이블에 있는 주소)가 목적지가 아니라면 해당 패킷을 버린다.

### 2. 브로드캐스트 컨트롤

패킷의 도착지 주소를 모를 경우, 스위치는 어딘가에 존재할 지 모르는 장비와의 통신을 위해 패킷을 모든 포트에 전송한다 (플러딩)

LAN은 크기가 작아 플러딩에 대한 영향이 작고, 도착지 NIC에서 자신의 주소와 패킷 도착지의 주소가 다르면 패킷을 버리기에 큰 무리가 되지 않는다.

라우터는 분명한 도착지 정보가 있을 때만 통신을 허락하기에,

- 바로 연결되어 있는 네트워크 정보를 제외하고 경로 습득 설정을 하지 않으면 패킷을 포워딩 할 수 없고
- 라우터의 기본 동작은 멀티캐스트 정보를 습득하지 않고 브로드캐스트 패킷을 전달하지 않는다.

이러한 라우터의 기능을 이용해 브로드캐스트가 다른 네트워크에 전파되는 것을 막을 수 있다.

따라서, 네트워크에 브로드캐스트가 많이 발생하는 경우, 라우터로 네트워크를 분리하여 브로드캐스트 네트워크를 분할해 성능을 높일 수 있다.

### 3. 프로토콜 변환

서로 다른 프로토콜로 구성된 네트워크를 연결하는 역할 또한 수행한다.

현재는 이더넷으로 수렴되어 해당 역할이 많이 줄어들었지만,
과거 LAN 기술이 WNA 기술로 변환되어야 원격지 네트워크와의 통신이 가능한 상황이 있었기에 해당 기능이 존재하는 것이다.

# 라우팅 동작 및 라우팅 테이블

## Hop-by-Hop 라우팅 (홉 바이 홉)

<img width="1325" height="528" alt="image" src="https://github.com/user-attachments/assets/cb2fef95-8865-4d0b-a588-eb338f26d873" />

바로 다이렉트로 목적지 네트워크에 패킷을 전달하는 것이 아닌,

실제 가장 가까운 라우터에 연결하고, 패킷을 전달함을 반복하며 목적지에 도달하게 된다.
이때 거쳐간 라우터의 개수를 말할 때 `홉`이라고 말하고, 이를 컴퓨터 사이의 거리라고 말한다.

가장 단순한 모델이다.

### 다음-홉 방법 (Next-Hop method)

라우팅 테이블은 처음부터 모든 것을 주지 않는다.

처음부터 모든 경로를 저장하고 있다면, 라우팅 테이블이 너무 커져 매우 비효율적인 검색 성능과 부하로 인한 성능 저하를 우려할 수 있다.

따라서, 다음에 거쳐갈 홉(라우터)의 주소만을 전달하고, 그리고 다음 홉에 등장했을 때는 또 거쳐가야 할 다음 홉의 주소를 전달하며 라우팅 테이블을 단순화한다.

<img width="1148" height="536" alt="image" src="https://github.com/user-attachments/assets/8262aace-e430-4f98-b59a-a1a5d007e310" />

### 홉(Hop)이란?

통신망에서 각 패킷이 여러 개의 라우터를 건너가는 모습을 비유적으로 표현

컴퓨터 사이의 거리를 통과한 라우터의 개수로 나타낸다.
위 그림 기준으로는 2홉이 걸린 셈.

또한, 중간 네트워크(서브 네트워크라고도 함)를 건너 도착지 네트워크에 도착한다는 말인데, 그림 기준으로는 네트워크 2가 서브 네트워크라고 칠 수 있다.

## 라우팅 테이블

IP 주소를 기반으로 라우터의 위치를 저장한 테이블 또는 데이터베이스

다양한 네트워크에 대한 정보와 해당 네트워크에 연결하는 방법이 포함되어 있음

가장 단순한 방식은 hop-by-hop 라우팅 방식이다.
당연하게도, 세상은 발전해 왔기에 MPLS와 같은 계층적 아키텍처 또한 존재하며 현재는 이와 같은 계층적 아키텍처를 이용한 라우팅을 많이 사용하고 있다고 한다. (테이블 검사 시간 감소 및 네트워크 성능 증가)

hop-by-hop 라우팅 방식에서, 각 라우터의 라우팅 테이블은 모든 목적지 정보에 대해 해당 목적지에 도달하기 위해서 거쳐야 할 다음 라우터의 정보를 가지고 있다. (경로 지정 기반 라우팅 테이블)

<img width="716" height="144" alt="image" src="https://github.com/user-attachments/assets/7164565e-b230-498d-a7aa-a2702b07a779" />

netstat -r (or route print)을 통해 라우팅 테이블을 한 번 보았다.

<img width="690" height="94" alt="image" src="https://github.com/user-attachments/assets/85479895-54b6-4998-a981-15b1024bcf6c" />

얘는 Ubuntu

### 라우팅 테이블의 구성요소

- (목적지) 목적지 주소
    - 목적지 네트워크 주소
    - 자원 절약을 위해, 호스트 주소 단위가 아닌 목적지 네트워크 단위로 저장 관리
    - 목적지 네트워크: 목적지 네트워크에 대한 여러 관련 정보 (IP 주소, 서브넷 등)
- (방향) Next-Hop 인터페이스
    - 패킷의 입출력 관계
    - 목적지 네트워크 주소로 가기 위한 라우터의 출구 포트에 대한 정보
    - Next Hop 주소: 목적지 네트워크까지 가기 위한 바로 다음에 거쳐야 할 라우터의 IP 주소
- (거리) Administrative Distance(=Distance)
    - 목적지 라우팅을 위한 메트릭 정보
    - 보통, 6개 정도까지의 최적 루트를 계산해내며, 이들 사이에 트래픽을 로드밸런싱
        - 동일 목적지 경로에 대한 정보가 인접 라우터들로부터 여럿 수신될 때, 비용이 더 적게 소모되는 기준값 정보 취함
    - 결국 모든 목적지 네트워크마다 최적 경로가 결정된 표를 만들게 됨
        - 각 원격 네트워크 경로에 대해 계산된 어떤 수치 값(메트릭 값)을 가짐
    - Administrative Distance: 위 학습 방법이 신뢰되는 정도 (수치가 작을수록 신뢰도가 높음)
- Metric(=Cost)
    - 라우팅 메트릭
    - 최적 경로 서열 값

### 라우팅 테이블의 갱신

- 이웃 라우터끼리 라우팅 테이블 항목을 주고받으며 자신의 테이블을 갱신
- 만일 라우팅 테이블에 수신된 패킷의 목적지 주소가 없다면, 라우터는 해당 패킷을 폐기
    - 이때, 라우터는 Destination Unreachable 이라는 ICMP 메시지를 출발지에 보냄

## 게이트웨이 (Gateway)

- 서로 다른 통신망, 프로토콜을 사용하는 네트워크 간의 통신을 가능하게 하는 관문 역할을 하는 컴퓨터나 소프트웨어를 두루 일컫는 용어
(마치 톨게이트와 같다)
- 서로 다른 네트워크 상의 통신 프로토콜을 변환해 주는 역할을 하기도 함

# IP 주소 체계

## IPv4와 IPv6

일반적으로 사용되는 주소 체계는 IPv4이지만, IPv6로 가고 있는 추세이다.

컴퓨터가 보편화되고, 스마트폰, IoT 기술이 발전하면서 기존 IPv4를 이용한 주소가 고갈되어 가는 상황이 발생한다.

이에, IPv6라는 체계를 새로 만들어 64비트를 16비트 단위로 :(콜론)을 통해 표현한다.

이러한 IP 주소가 어떻게 할당되었는지에 대해 알아보도록 한다.

## 클래스 기반 할당 방식

처음에는 A, B, C, D, E 총 다섯 개의 클래스로 구분하는 클래스 기반 할당 방식을 사용했다.

<img width="1410" height="905" alt="image" src="https://github.com/user-attachments/assets/471f9325-c13a-4ace-9733-7c733fbd8c55" />

하지만, 단순히 이렇게 나누었을 때, 버려지는 주소가 많았기에 이를 해소하기 위해서 다양한 방법이 나왔다.

A 클래스에 할당할 수 있는 주소는 1,600만 개, B 클래스는 65,000개, C 클래스는 약 250개로 각 클래스별로 할당할 수 있는 호스트 주소의 개수 차이가 상당히 컸다.

만약 300대의 컴퓨터를 가지고 있어서 C 클래스는 사용하지 못하고, B 클래스를 사용해야 한다면? 그럼 64,700개의 IP는 사용되지 않는 것이다. 

이를 위해 서브넷팅과 슈퍼넷팅이 제시되었다.

## 서브넷팅과 슈퍼넷팅

이 둘 모두, 부족한 IP 자원을 조금 더 효율적으로 활용하기 위해 제시되었다.

### 서브넷팅 (Subnetting)

서브넷을 만들기 위해 네트워크를 분할하는 것

동일 네트워크를 작은 그룹으로 나누기 위해 그룹화하는 것

- 서브넷 마스크를 이용하여 네트워크를 더 작게 나누는 것

### 슈퍼넷팅 (Supernetting)

다수의 작은 네트워크를 하나의 큰 네트워크로 통합하는 것

- 서브넷팅의 반대 개념

## CIDR (Classless Inter-Domain Routing, 사이더)

클래스 없는 도메인 간 라우팅 기법 (조금 더 유연한 방식!)

`192.168.10.80/26` 과 같이 표기한다

특수 IP 주소가 존재한다.

- 클래스에 국한되지 않고 IP 주소를 쪼개고, 합치는 등의 방식으로 더욱 효율적으로 IP 주소를 사용할 수 있도록 하는 방법.
- 만약, 서브넷팅을 추가적으로 해야 한다면 (네트워크를 더 작게 쪼갤 필요가 있다면) → /26을 /27로 늘려 더 작은 네트워크로 만들면 된다.
- 만약, 슈퍼넷팅을 추가적으로 해야 한다면 (하나의 네트워크에 더 많은 기기가 필요하다면) → /26을 /25로 줄여 더 큰 네트워크로 만들면 된다.

- 특수 IP 주소
    - 0.0.0.0: “이 네트워크”를 나타냄
    - 127.0.0.0/8: 루프백 주소 (ex. 127.0.0.1)
    - 169.254.0.0/16: 링크-로컬 주소 (APIPA)

### APIPA란? (Automatic Private IP Addressing, 사설 IP 주소 자동 할당)

윈도우 기반 운영체제에서 지원되는 것으로, DHCP 서버가 없는 네트워크에서 컴퓨터가 스스로 IP 주소를 자동으로 할당해 주는 기능.

DHCP 서버가 정지되었을 때 자동으로 그 임무를 이어받아 수행하거나, 소규모 근거리통신망의 구성이나 지원을 보다 쉽게 해주는 등의 역할을 수행한다.

# DHCP (Dynamic Host Configuration)

호스트가 네트워크와 통신하려면 많은 설정이 필요하다.

물리적 네트워크 구성은 당연하고, IP, 서브넷 마스크, 게이트웨이와 같은 네트워크 정보와 DNS 주소 등 다양한 설정이 필요하다. 그리고 이러한 네트워크 정보들을 호스트에 적용하려면 사용자가 IP 정보를 직접 설정하거나 IP 정보를 할당해주는 서버를 이용해 자동으로 설정해야 한다.

이때, 수동으로 IP와 네트워크 정보를 직접 설정하는 것을 `정적 할당`이라고 하고, 자동으로 설정하는 것을 `동적 할당`이라고 한다.

일반적으로 데이터 센터의 서버 팜과 같은 운영 망에서 사용되는 IP는 주로 정적 할당을 사용하지만,
PC 사용자를 위해 운영되는 사무실 네트워크에서는 IP를 자동으로 할당받는 동적 할당 방식을 많이 사용한다.

이러한 동적 할당에 사용되는 프로토콜이 DHCP이다.

클라이언트의 서비스 포트는 68(bootpc), 서버의 서비스 포트는 69(bootps)

이후, 임대 시간이 만료되면 클라이언트에 할당된 IP를 다시 IP Pool로 회수한다.

<img width="2028" height="1708" alt="image" src="https://github.com/user-attachments/assets/1af4ad7f-80a1-4e0a-851c-7f5231153cbf" />

<img width="651" height="231" alt="image" src="https://github.com/user-attachments/assets/35598371-3b14-4564-9737-e7d75f8b3a44" />

윈도우 11 기준, 내 컴퓨터의 이더넷 기준 이와 같이 DHCP를 이용하여 자동으로 할당되고 있음을 알 수 있다.
(편집을 누르면 수동으로 사용이 가능한데, 혹시 모르니 그냥 냅두도록 했다ㅎㅎ)

#### 나의 작은 궁금증

윈도우 OS에서는 기본적으로 APIPA가 지원된다고 한다. 그럼 route print를 했을 때, 내 라우팅 테이블에도 APIPA용 예약 주소인 `169.254.0.0/16`이 넣어져야 하지 않을까?
(물론 내 컴퓨터는 정상적으로 LAN 케이블로 연결이 되어 DHCP로 IP를 잘 할당 받고 있기는 하다)

⇒ 연결이 잘 되고 있기에 진행되지 않는다고 한다.

APIPA의 경우, DHCP 주소를 받아오지 못하는 비상시(예외 상황)에만 자동적으로 할당되고, 이 때만 라우팅 테이블에 등장한다.

평상시에는 나타나지 않고, 문제가 있을 때만 나타나는 안전망 같은 주소로 이해하면 된다고 한다.

# NAT (Network Address Translation)

네트워크 주소 변환

패킷이 라우팅 장치를 통해 전송되는 동안 패킷의 IP 주소 정보를 수정하여 IP 주소를 다른 주소로 매핑하는 방법.

대개, 사설 네트워크에 속한 여러 개의 호스트가 하나의 공인 IP 주소를 사용하여 인터넷에 접속하기 위해 사용된다.

### 사설망 (Private Network)

IPv4 중 특정 대역을 공인 인터넷이 아닌 가정, 기업 등의 한정된 공간에 사용한 네트워크.

> 사설 IP 대역
> 
> 
> 10.0.0.0~10.255.255.255, 172.16.0.0~172.31.255.255, 192.168.0.0~192.168.255.255
> 

사설망에 소속된 IP는 오로지 사설망(내부망)에서만 사용 가능하기 때문에 공인망(외부망, 인터넷)에서는 사용할 수 없다.

그런데 이렇게 사설망과 공인망이 분리되면서 이 경계에 대한 조치를 취해야 할 필요성이 있다.

마치, 대학교 내부에서는 그냥 내 이름인 “김이름”으로 돌아다니지만, 박람회나 큰 행사를 신청할 때에는 내가 속해있는 공식적인 조직/신분인 “00대학교 학부생”으로 돌아다니는 것처럼.

### NAT

사설망에서 공인망으로, 공인망에서 사설망으로 통신하고자 할 때 공인망/사설망에서 사용하는 IP로 변환하는 것. IP 주소 뿐만 아니라 IP 패킷의 TCP/UDP Port 숫자를 변환 및 재기록하여 네트워크 트래픽을 주고 받는 기술을 의미한다. (IP 주소, 포트 번호를 변환시켜 사용 가능)
이 때 포트 번호를 변환시킬 때에는 PAT(Port Address Translation)이라고 한다.

회사에 있을 때(in 사설망)에는 그냥 김사원으로 불리지만, 거래처와 미팅하는 공적 자리에서는 00회사 00부 1팀 김사원이 되는 것과 같이, 공적인 공간에 있을 때(in 공인망)에 이름표를 새로 붙여주는 것이다.

이와 같이, 사내에서는 사설 IP를 사용하다가 외부에 메일을 보낼 필요성이 있을 때,
메일이 사설망에서 공인망으로 나가야 한다. 이 때, NAT를 통해 내 PC의 IP가 아닌 회사의 공인 IP로 바꾸어 이 회사에서 메일을 보냈다, 만 알 수 있도록 하는 것이다.

- 장점
    - 공인 IP 주소 절약: 여러 개의 사설 IP 주소를 하나의 공인 IP 주소로 변환하여 사용 가능
    - 보안 강화: 내부 IP를 숨기다보니 내부 네트워크 구조를 알 수 없게 되어 간접적 보안 효과
    - IP 충돌 방지: 내부 네트워크에서 동일한 IP 대역을 사용할 수 있도록 지원
    - 확장의 용이함: 로컬 네트워크에 새 장비를 추가하는 것이 쉽다
- 단점
    - 복잡성: 추가적인 시스템이기에, 복잡성을 증가시킨다
    - 특정 애플리케이션과의 호환성 문제: IP 헤더 필드만 수정하고, 데이터 영역은 수정하지 않기에 특정 애플리케이션에 호환성 문제를 야기시킬 수 있다
    - 보안 프로토콜 문제: IPSec과 같은 프로토콜은 헤더의 변조를 탐지하도록 설계했기에, NAT에 의한 변경과 악성 데이터그램 해킹을 오탐할 수 있다.
    (요즘은 NAT-T 기술로 우회가 가능하다고는 하다)
    - 성능 감소: 패킷이 사설망과 공인망을 오갈 때마다 주소 변환이 필요하다

# 참고자료

https://blog.naver.com/onsystems/223399141535

https://chaeyami.tistory.com/199

https://chaeyami.tistory.com/201#%EB%9D%BC%EC%9A%B0%ED%8C%85%20%EB%8F%99%EC%9E%91%EA%B3%BC%20%EB%9D%BC%EC%9A%B0%ED%8C%85%20%ED%85%8C%EC%9D%B4%EB%B8%94-1

https://june-17.tistory.com/340

http://www.ktword.co.kr/test/view/view.php?m_temp1=1327

https://louis-j.tistory.com/entry/%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC-%EC%8A%88%ED%8D%BC%EB%84%B7%ED%8C%85Supernetting

https://watermelon-sugar.tistory.com/47

https://easyitwanner.tistory.com/75

https://aws-hyoh.tistory.com/145

https://nroses-taek.tistory.com/113
